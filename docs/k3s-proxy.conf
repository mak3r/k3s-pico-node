# nginx TLS Proxy Configuration for k3s-pico-node
#
# This proxy terminates TLS for Raspberry Pi Pico W clients and forwards
# authenticated requests to the k3s API server.
#
# Installation:
#   sudo cp k3s-proxy.conf /etc/nginx/sites-available/
#   sudo ln -s /etc/nginx/sites-available/k3s-proxy.conf /etc/nginx/sites-enabled/
#   sudo nginx -t
#   sudo systemctl restart nginx
#
# Firewall:
#   sudo firewall-cmd --zone=internal --add-port=6080/tcp --permanent
#   sudo firewall-cmd --reload
#
# See: docs/NGINX-PROXY-SETUP.md for detailed setup instructions

server {
    # Listen on port 6080 for HTTP requests from Picos
    listen 6080;
    server_name _;

    # SECURITY: Only allow local network access
    # Adjust these subnets to match your network
    allow 192.168.0.0/16;  # Private Class C
    allow 10.0.0.0/8;      # Private Class A
    allow 172.16.0.0/12;   # Private Class B
    deny all;              # Deny everything else

    # Logging
    access_log /var/log/nginx/k3s-proxy-access.log;
    error_log /var/log/nginx/k3s-proxy-error.log;

    location / {
        # Forward to k3s API on localhost
        proxy_pass https://127.0.0.1:6443;

        # Use k3s admin certificate for authentication
        # These files are created by k3s installation
        proxy_ssl_certificate /var/lib/rancher/k3s/server/tls/client-admin.crt;
        proxy_ssl_certificate_key /var/lib/rancher/k3s/server/tls/client-admin.key;
        proxy_ssl_trusted_certificate /var/lib/rancher/k3s/server/tls/server-ca.crt;
        proxy_ssl_verify on;
        proxy_ssl_verify_depth 2;

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Kubernetes API requires HTTP/1.1 for WebSocket upgrades (Watch API)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Disable buffering for streaming responses (Watch API)
        proxy_buffering off;
        proxy_request_buffering off;

        # Timeouts (Kubernetes operations can be long-running)
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}
